---
title: "ACLIM2 ESR indices"
author: K. Holsman
always_allow_html: true
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: true
  header-includes:
  - \usepackage{knputenc}
  - \usepackage{unicode-math}
  - \pagenumbering{gobble}
  - \documentclass{article}
  - \usepackage{amsmath}
  word_document:
    fig_caption: yes
    fig_width: 4
    keep_md: yes
  pdf_document:
    toc: TRUE
    toc_depth: 3
    fig_caption: yes
    fig_height: 4
    fig_width: 5
    highlight: tango
    keep_tex: yes
    latex_engine: xelatex
#runtime: shiny
---



```{r startup, eval=TRUE, echo=FALSE, results='hide',message=FALSE}
 
 #source("R/make.R")       # loads packages, data, setup, etc.
 knitr::opts_chunk$set(echo = T, fig.align="center",warning = FALSE, message = FALSE)
 #knitr::opts_knit$set(root.dir = '../')
 #options(knitr.table.format = "latex")
 thisYr <- format(Sys.time(), "%Y")
 today  <- format(Sys.time(), "%b %d, %Y")
 
```


## Set up the Workspace

Open R() and used 'setwd()' to navigate to the root ACLIM2 folder (.e.g, ~/mydocuments/ACLIM2)

```{R  start, eval=TRUE, echo=T, results='show',message=FALSE}
    
    # set the workspace to your local ACLIM2 folder
    # e.g., "/Users/kholsman/Documents/GitHub/ACLIM2"
    # setwd( path.expand("~/Documents/GitHub/ACLIM2") )
   
    # --------------------------------------
    # SETUP WORKSPACE
    tmstp  <- format(Sys.time(), "%Y_%m_%d")
    main   <- getwd()  #"~/GitHub_new/ACLIM2"
    
    # loads packages, data, setup, etc.
    suppressWarnings(source("R/make.R"))
```



## ROMSNPZ variables

For a list of the available variables from the ROMSNPZ:

```{R, eval=TRUE, echo=T, results='show',message=FALSE}
    # Metadata for variables
    (srvy_var_def[-(1:5),])

```


```{R, eval=TRUE, echo=T, results='show',message=FALSE}
    # Metadata for Weekly ("ACLIMregion_...") indices
    head(all_info1)
    
    # Metadata for Weekly ("ACLIMsurveyrep_...") indices
    head(all_info2)
    
```

# Indices & bias correction {.tabset}

```{r, eval=F, include=T,echo=T}

shiny::runApp("/Users/kholsman/Documents/GitHub/ACLIM2/R/shiny_aclim/ACLIM2_indices/app.R")

# alternatively you can extract the data you want using the get_var()function

df <- get_var(typeIN    = "annual", 
         plotvar = "temp_bottom5m",plothist =F)

df$plot
head(df$dat)



```

!["Raw (top row) and bias corrected (bottom row)bottom temperature indices based on survey replicated Level3 outputs for the SEBS"](Figs/biascorrected_temp2.png){width=100%}

<!-- ## Annual indices -->

<!-- ```{r explore, eval=F, include=T,echo=T} -->
<!--     # -------------------------------------- -->
<!--     # SETUP WORKSPACE -->
<!--     main   <- getwd()  #"~/GitHub_new/ACLIM2" -->

<!--     # loads packages, data, setup, etc. -->
<!--     suppressMessages(source("R/make.R")) -->


<!--     # load the Indices: -->
<!--     fldr <- "Data/out/K20P19_CMIP6/allEBS_means" -->
<!--     dirlist <-grep ("annual", dir(fldr)) -->
<!--     for(d in dirlist) -->
<!--       load(file.path(fldr,d)) -->
<!--     hnd <- ACLIM_annual_fut_mn -->

<!-- ```` -->


<!-- # Special cases {.tabset} -->
## NRS indices (André)

```{r, eval=T, include=T,echo=T, results='hide',message=FALSE}

suppressMessages(source("R/make.R"))

# preview possible variables
    
    load(file = "Data/out/weekly_vars_C.Rdata")
    load(file = "Data/out/weekly_vars.Rdata")
    load(file = "Data/out/srvy_vars_C.Rdata")
    load(file = "Data/out/srvy_vars.Rdata")
    
load(paste0("Data/out/K20P19_CMIP5_C/allEBS_means/ACLIM_annual_hind_mn.Rdata"))
load(paste0("Data/out/K20P19_CMIP5_C/allEBS_means/ACLIM_annual_fut_mn.Rdata"))

load(paste0("Data/out/K20P19_CMIP5_C/allEBS_means/ACLIM_seasonal_hind_mn.Rdata"))
load(paste0("Data/out/K20P19_CMIP5_C/allEBS_means/ACLIM_seasonal_fut_mn.Rdata"))

ACLIM_seasonal_hind_mn

varall  <- unique(ACLIM_annual_hind$var)
varall

df <- ACLIM_annual_hind%>%filter(var%in%c("temp_bottom5m",
                                          "temp_depthavg",
                                          "pH_bottom5m",
                                          "pH_depthavg"))%>%
  cast(basin +year+type+scen~var,mean,value="mn_val")%>%
  rename(season =type)
df$scen <- "hind_cmip5"
 
df_season <- ACLIM_seasonal_hind%>%
  filter(var%in%c("temp_bottom5m",
                  "temp_depthavg",
                  "pH_bottom5m",
                  "pH_depthavg")
         # ,season%in%c(
         #   "Spring","Summer")
         )%>%
  cast(basin +year+season+scen~var,mean,value="mn_val")   
df_season$scen <- "hind_cmip5"
  
dfF <- ACLIM_annual_fut%>%filter(var%in%c("temp_bottom5m",
                                          "temp_depthavg",
                                          "pH_bottom5m",
                                          "pH_depthavg"))%>%
  cast(basin +year+type+scen~var,mean,value="mn_val")%>%
  rename(season =type)
 
df_seasonF <- ACLIM_seasonal_fut%>%
  filter(var%in%c("temp_bottom5m",
                  "temp_depthavg",
                  "pH_bottom5m",
                  "pH_depthavg")
         # ,season%in%c(
         #   "Spring","Summer")
         )%>%
  cast(basin +year+season+scen~var,mean,value="mn_val")   
 
 df_5 <- rbind(df,dfF,df_season,df_seasonF)
 
    
load(paste0("Data/out/K20P19_CMIP6_C/allEBS_means/ACLIM_annual_hind_mn.Rdata"))
load(paste0("Data/out/K20P19_CMIP6_C/allEBS_means/ACLIM_annual_fut_mn.Rdata"))

load(paste0("Data/out/K20P19_CMIP6_C/allEBS_means/ACLIM_seasonal_hind_mn.Rdata"))
load(paste0("Data/out/K20P19_CMIP6_C/allEBS_means/ACLIM_seasonal_fut_mn.Rdata"))
 
 df <- ACLIM_annual_hind%>%filter(var%in%c("temp_bottom5m",
                                          "temp_depthavg",
                                          "pH_bottom5m",
                                          "pH_depthavg"))%>%
  cast(basin +year+type+scen~var,mean,value="mn_val")%>%
  rename(season =type)
 #df$scen <- "hind_cmip6"
 
df_season <- ACLIM_seasonal_hind%>%
  filter(var%in%c("temp_bottom5m",
                  "temp_depthavg",
                  "pH_bottom5m",
                  "pH_depthavg")
         # ,season%in%c(
         #   "Spring","Summer")
         )%>%
  cast(basin +year+season+scen~var,mean,value="mn_val")   
 #df_season$scen <- "hind_cmip6"
dfF <- ACLIM_annual_fut%>%filter(var%in%c("temp_bottom5m",
                                          "temp_depthavg",
                                          "pH_bottom5m",
                                          "pH_depthavg"))%>%
  cast(basin +year+type+scen~var,mean,value="mn_val")%>%
  rename(season =type)
 
df_seasonF <- ACLIM_seasonal_fut%>%
  filter(var%in%c("temp_bottom5m",
                  "temp_depthavg",
                  "pH_bottom5m",
                  "pH_depthavg")
         # ,season%in%c(
         #   "Spring","Summer")
         )%>%
  cast(basin +year+season+scen~var,mean,value="mn_val")   
 
 df_6 <- rbind(df,dfF,df_season,df_seasonF)
 df <-rbind(df_5,df_6)
 df$season<-factor(df$season,levels=c("annual means","Winter","Spring","Summer","Fall"))

ggplot(data = sub )+
  geom_line(aes(x=year,y= mn_val))+
  facet_wrap(basin~var)+theme_minimal()
# swinny et al
# ambient ph = 7.99; pH 7.8,, ambient temperature, ambientþ2C, andambient þ4C, 
# ) red king crab
# survival, growth, and morphology, we conducted a long-term, fully
# crossed experiment with two pHs and three temperatures: ambient
# pH (7.99), pH 7.8, ambient temperature, ambientþ2C, and
# ambient þ4C, for a total of 6 treatments. A pH treatment lower
# than pH 7.8 was not included in this study because in a previous
# study 100% mortality occurred within 95 d for young-of-the-year
# red king crab exposed to pH 7.5 waters (Long et al., 2013b).

ggplot(data = df )+
  geom_hline(yintercept = 7.8, linetype="dashed",color="gray",size=1)+
  geom_point(aes(x=temp_depthavg,y= pH_depthavg, color=year), size=2)+
    geom_text(aes(x=temp_depthavg,y= pH_depthavg, color=year,label=year ), size=3, vjust = 1,hjust = -.5)+
  theme_minimal()+scale_color_viridis_c(end=0,begin=.9)+facet_grid(basin~season)

ggplot(data = df )+
  geom_hline(yintercept = c(7.8), linetype=("dashed"),color="gray",size=1)+
  geom_hline(yintercept = c(7.5), linetype=("solid"),color="gray",size=1)+
  geom_point(aes(x=year,y= pH_bottom5m, color=scen), size=2,alpha=.5)+
  geom_smooth(aes(x=year,y= pH_bottom5m, color=scen),fill=NA,method = loess,size=1.5)+
  theme_minimal()+scale_color_viridis_d(end=0,begin=.9)+
  #scale_fill_viridis_d(end=0,begin=.9)+
  facet_grid(basin~season)

ggplot(data = df )+
   geom_point(aes(x=year,y= temp_bottom5m, color=scen), size=2,alpha=.5)+
  geom_smooth(aes(x=year,y= temp_bottom5m, color=scen),fill=NA,method = loess,size=1.5)+
  theme_minimal()+scale_color_viridis_d(end=0,begin=.9)+
  #scale_fill_viridis_d(end=0,begin=.9)+
  facet_grid(basin~season)

```

```{r}
library("cluster")
library("factoextra")
library("magrittr")



df2 <- df_6 %>%
  filter(season=="Summer",scen%in%c("hind","ssp585"), basin =="NEBS",year>2010,year<2060)%>%
  mutate(id = factor(paste(year, scen),levels=paste(year,scen)))
  #mutate(id = factor(paste(year, scen,basin),levels=paste(year,scen,basin)))
rownames(df2)<-df2$id
df3<-data.frame(na.omit(df2[,5:8]))
df3<-data.frame(na.omit(df2[,c(5,7)]))


# Compute hierarchical clustering
res.hc <- df3 %>%
  scale() %>%                    # Scale the data
  dist(method = "euclidean") %>% # Compute dissimilarity matrix
  hclust(method = "ward.D2")     # Compute hierachical clustering

# Visualize using factoextra
# Cut in 4 groups and color by groups
p <- fviz_dend(res.hc, k = 4, # Cut in four groups
          cex = 0.5, # label size
          k_colors = c("#2E9FDF", "#00AFBB", "#E7B800", "#FC4E07"),
          color_labels_by_k = TRUE, # color labels by groups
          rect = TRUE # Add rectangle around groups
          )
dpi = 350
w <-7
h =5
jpeg(filename = "Figs/cluster_NEBS.jpg",width = w, height = h, res=dpi,units="in")
p
dev.off()

#########################################


res.dist <- get_dist(df3, stand = TRUE, method = "pearson")

fviz_dist(res.dist,  show_labels = TRUE,
   gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))


set.seed(123)
km.res <- kmeans(df3, 3, nstart = 25)
# Visualize
library("factoextra")
fviz_cluster(km.res, data = df3,
             ellipse.type = "convex",
             palette = "jco",
             ggtheme = theme_minimal())



set.seed(123)
# Enhanced hierarchical clustering, cut in 3 groups
res.hc <- df3%>%
  scale() %>%
  eclust("hclust", k = 3, graph = FALSE)

# Visualize with factoextra
fviz_dend(res.hc, palette = "jco",
          rect = TRUE, show_labels = FALSE)


library(dendextend)
library(circlize)
# Distance matrix
d <- dist(df3)

# Hierarchical clustering dendrogram
hc <- as.dendrogram(hclust(d))

# Circular dendrogram
circlize_dendrogram(hc,
                    labels_track_height = NA,
                    dend_track_height = 0.5,
                    facing = "inside")


```



```{r}

ggplot(data = df)+
  geom_point(aes(x=year,y= temp_bottom5m, color=scen), size=2,alpha=.5)+
   # geom_text(aes(x=year,y= pH_depthavg, color=year,label=year ), size=3, vjust = 1,hjust = -.5)+
  geom_smooth(aes(x=year,y= temp_bottom5m, color=scen),fill=NA,method = loess,size=1.5)+
  theme_minimal()+scale_color_viridis_d(end=0,begin=.9)+
  #scale_fill_viridis_d(end=0,begin=.9)+
  facet_grid(basin~season)



# get the variable you want:
df <- get_var( typeIN    = "annual", 
               plotvar   = varlist[3],
               bcIN      = "raw",
               CMIPIN    = "K20P19_CMIP6_C", 
               plothist  = T,  # ignore the hist runs
               removeyr1 = T)  #"Remove first year of projection ( burn in)")

df$plot+coord_cartesian(ylim = c(0, 7)) 
head(df$dat)
# 
# # get the variable you want:
# df <- get_var( typeIN    = "annual", 
#                plotvar   = varlist[1],
#                bcIN      = "raw",
#                CMIPIN    = "K20P19_CMIP6_C", 
#                plothist  = F,  # ignore the hist runs
#                removeyr1 = T)  #"Remove first year of projection ( burn in)")
# 
# df$plot+coord_cartesian(ylim = c(0, 7)) 
# 
# head(df$dat)

# 
# # get the variable you want:
# df <- get_var( typeIN    = "annual", 
#                plotvar   = "uEast_surface5m",
#                bcIN      = "bias corrected",
#                CMIPIN    = "K20P19_CMIP6_C", 
#                plothist  = F,  # ignore the hist runs
#                removeyr1 = T)  #"Remove first year of projection ( burn in)")
# 
# df$plot
# head(df$dat)

# get the variable you want:
df <- get_var( typeIN    = "annual", 
               plotvar   = "pH_depthavg",
               bcIN      = "bias corrected",
               CMIPIN    = "K20P19_CMIP6_C", 
               plothist  = F,  # ignore the hist runs
               removeyr1 = T)  #"Remove first year of projection ( burn in)")

df$plot
head(df$dat)



```

```{r, eval=T, include=T,echo=T, results='show',message=FALSE}

# get the variable you want:
df <- get_var( typeIN    = "annual", 
               plotvar   = "pH_depthavg",
               bcIN      = "bias corrected",
               CMIPIN    = "K20P19_CMIP6_C", 
               plothist  = F,  # ignore the hist runs
               removeyr1 = T)  #"Remove first year of projection ( burn in)")

df$plot
head(df$dat)

# concat the hind and fut runs by removing years from projection
maxDin <- max(as.vector(df$dat%>%dplyr::filter(sim_type=="hind")%>%dplyr::select(mnDate))[[1]])



newdat <- stitchTS(dat = df$dat,
                 maxD  = maxDin)

# newdat has the full set of data
# select miroc_ssp126
head(newdat%>%dplyr::filter(GCM_scen==paste0(GCMs[1],"_",scens[1])))
tail(newdat%>%dplyr::filter(GCM_scen==paste0(GCMs[1],"_",scens[1])))

pp  <- ggplot(newdat)+
          geom_line(aes(x=mnDate,y=mn_val,color= GCM_scen, linetype = basin),
                    alpha = 0.6,show.legend = FALSE)+
          geom_smooth(aes(x=mnDate,y=mn_val,color= GCM_scen,
                          fill=GCM_scen,linetype = basin),alpha=0.1,
                      method="loess",formula='y ~ x',span = .5,show.legend=T)+
          theme_minimal() + 
          labs(x="Date",
                 y=paste(newdat$var[1],"(",newdat$units[1],")"),
                 subtitle = "",
                 legend = "",
                 title = paste(newdat$var[1],"(",newdat$basin[1],",",newdat$type[1],")"))+
        scale_color_discrete()+
        facet_grid(scen~.)
# plot it
pp
        
```

```{r, fig.width=8, fig.height=6, fig.fullwidth=TRUE, echo =T, eval=T}
# plot it interactively
plotly::ggplotly(pp)
```

## monthly indices (Andy)

```{r ewe, eval=T, include=T,echo=T, results='hide',message=FALSE}

suppressMessages(source("R/make.R"))

# preview possible variables
load(paste0("Data/out/K20P19_CMIP6/allEBS_means/ACLIM_monthly_hind_mn.Rdata"))
varall  <- unique(ACLIM_monthly_hind$var)
varall

scens   <- c("ssp126","ssp585")
GCMs    <- c("miroc","gfdl",  "cesm" )
varlist <- c("temp_bottom5m","fracbelow2","uEast_surface5m")

# get the variable you want:
df <- get_var( typeIN    = "annual", 
                CMIPIN    = "K20P19_CMIP6_C",
                plotvar   = "uEast_surface5m",
                bcIN      = "bias corrected",
                plothist  = F,  # ignore the hist runs
                removeyr1 = T)  #"Remove first year of projection ( burn in)")

df <- get_var( typeIN    = "monthly", 
               CMIPIN    = "K20P19_CMIP6_C",
               monthIN   = 2,
               plotvar   = "temp_bottom5m",
               bcIN      = "bias corrected",
               plothist  = F,  # ignore the hist runs
               removeyr1 = T)  #"Remove first year of projection ( burn in)")


head(df$dat)
df$plot

# concat the hind and fut runs by removing years from projection
maxDin <- max(as.vector(df$dat%>%dplyr::filter(sim_type=="hind")%>%dplyr::select(mnDate))[[1]])

newdat <- stitchTS(dat = df$dat,
                 maxD  = maxDin)

# newdat has the full set of data
# select miroc_ssp126
head(newdat%>%dplyr::filter(GCM_scen==paste0(GCMs[1],"_",scens[1])))
tail(newdat%>%dplyr::filter(GCM_scen==paste0(GCMs[1],"_",scens[1])))


pp  <- ggplot(newdat)+
          geom_line(aes(x=mnDate,y=mn_val,color= GCM_scen, linetype = basin),
                    alpha = 0.6,show.legend = FALSE)+
          geom_smooth(aes(x=mnDate,y=mn_val,color= GCM_scen,
                          fill=GCM_scen,linetype = basin),alpha=0.1,
                      method="loess",formula='y ~ x',span = .5,show.legend=T)+
          theme_minimal() + 
          labs(x="Date",
                 y=paste(newdat$var[1],"(",newdat$units[1],")"),
                 subtitle = "",
                 legend = "",
                 title = paste(newdat$var[1],"(",newdat$basin[1],",",newdat$type[1],")"))+
        scale_color_discrete()+
        facet_grid(scen~.)
# plot it
pp
        
```

```{r, fig.width=8, fig.height=6, fig.fullwidth=TRUE, echo =T, eval=T}
# plot it interactively
plotly::ggplotly(pp)
```

## weekly indices (Jon)

```{r sizespec, eval=T, include=T,echo=T, results='hide',message=FALSE}

suppressMessages(source("R/make.R"))

# preview possible variables
load(paste0("Data/out/K20P19_CMIP6/allEBS_means/ACLIM_weekly_hind_mn.Rdata"))
varall  <- unique(ACLIM_weekly_hind$var)
varall


scens   <- c("ssp126","ssp585")
GCMs    <- c("miroc","gfdl",  "cesm" )
varlist <- c("temp_bottom5m","fracbelow2","uEast_surface5m")

# get the variable you want:
df <- get_var( typeIN    = "weekly", 
               plotvar   = "temp_bottom5m",
               bcIN      = "bias corrected",
               plothist  = F,  # ignore the hist runs
               removeyr1 = T)  #"Remove first year of projection ( burn in)")

df$plot
head(df$dat)

# concat the hind and fut runs by removing years from projection
maxDin <- max(as.vector(df$dat%>%dplyr::filter(sim_type=="hind")%>%dplyr::select(mnDate))[[1]])

newdat <- stitchTS(dat = df$dat,
                 maxD  = maxDin)

# newdat has the full set of data
# select miroc_ssp126
head(newdat%>%dplyr::filter(GCM_scen==paste0(GCMs[1],"_",scens[1])))


pp  <- ggplot(newdat)+
          geom_line(aes(x=mnDate,y=mn_val,color= GCM_scen, linetype = basin),
                    alpha = 0.6,show.legend = FALSE)+
          geom_smooth(aes(x=mnDate,y=mn_val,color= GCM_scen,
                          fill=GCM_scen,linetype = basin),alpha=0.1,
                      method="loess",formula='y ~ x',span = .5,show.legend=T)+
          theme_minimal() + 
          labs(x="Date",
                 y=paste(newdat$var[1],"(",newdat$units[1],")"),
                 subtitle = "",
                 legend = "",
                 title = paste(newdat$var[1],"(",newdat$basin[1],",",newdat$type[1],")"))+
        scale_color_discrete()+
        facet_grid(scen~.)
# plot it
pp
        
```

```{r, fig.width=8, fig.height=6, fig.fullwidth=TRUE, echo =T, eval=T}
# plot it interactively
plotly::ggplotly(pp)
```

<!-- ## Salmon index (Ellen) -->

<!-- ## NFS index (Jeremy ) -->

---

# Output to .dat file (ADMB/ TMB users)

For CEATTLE I create a .dat file that is read into the ADMB script. That .dat file includes the bias corrected values (e.g., bottom temperature in deg C) used for the bioenergetics and temperature-dependent growth functions as well as Z-score (scaled) values used as covariates on the recruitment function. The section below will step through that .dat file creation for a subset of variables as well as demo chunks of ADMB code for reading that into a ADMB based model.

## Use R to make .dat file
```{r makedat, eval=F, include=T,echo=T}
  
  # 1 -- create .dat filename & path
  # 2 -- rescale (Z-score) data and get variables
  # 3 -- write data to hind .dat file
  # 3 -- write data to fut  .dat file
  
  # 1 -- create .dat filename & path
  # -------------------------------------

  # Define the name for the .dat file
    file.name   <- "ACLIM2_CMIP6_short"
    fn          <- paste(file.name,"_bcs.dat",sep="")
    archive_old <- T           # Archive the older version of the .dat file?
    
    
    outpath    <- "Data/out/ADMB_datfiles"
    if(!dir.exists(outpath)) dir.create(outpath)
    
  # define hind and fut data files
    fndat_hind <- file.path(outpath,paste("KKHhind_",fn,sep=""))
  	fndat_fut  <- file.path(outpath,paste("KKHfut_",fn,sep=""))
  	fndat_hind2 <- file.path(outpath,paste("hind_",fn,sep=""))
  	fndat_fut2  <- file.path(outpath,paste("fut_",fn,sep=""))
  	
	# create and archive .dat files
	  outfile    <- fndat_fut
  	if(file.exists(outfile)&archive_old){	
  	    # archive older version
  			archivefl <- paste0(substr(outfile,start=1,stop=nchar(outfile)-4),
  			                format(Sys.time(), "%Y%m%d"),".dat")
  			file.rename(outfile, archivefl)
  			file.remove(outfile)
  	}
  	
  	file.create(outfile)
  	outfile  <- fndat_hind
  	if(file.exists(outfile)&archive_old){	
  	    # archive older version
  			archivefl <- paste0(substr(outfile,start=1,stop=nchar(outfile)-4),
  			                format(Sys.time(), "%Y%m%d"),".dat")
  			file.rename(outfile, archivefl)
  			file.remove(outfile)
  	}
  	
  	file.create(outfile)

  	# 2 -- rescale (Z-score) data and get variables
  	
    # CMIPS <- c("K20P19_CMIP6","K20P19_CMIP5")
    # CMIPS <- c("K20P19_CMIP6")
    CMIPS <- c("K20P19_CMIP6_C")
    
    	# preview possible variables
  	load(paste0("Data/out/",CMIPS[1],"/allEBS_means/ACLIM_annual_hind_mn.Rdata"))
    varall  <- unique(ACLIM_annual_hind$var)
    varall
    
    # get each variable, convert to TS and rbind
   
    plotbasin <- "SEBS"
    # switches 
    lastyr_hind <- 2020
    hind_yrs    <- 1989:lastyr_hind   # define the years of your estimation model
    fut_yrs     <- (lastyr_hind+1):2100   # define the years of your projections
    
    
    for(c in 1:length(CMIPS)){
      
      # first for annual mean values:
      #varlist <- c("largeZoop_integrated","fracbelow2","temp_bottom5m","temp_surface5m")
      varlist <- c("largeZoop_integrated","fracbelow2",
                   "temp_bottom5m","temp_surface5m","pH_depthavg")
      typeIN <- "annual"
       
      load(paste0("Data/out/",CMIPS[c],"/allEBS_means/ACLIM_",typeIN,"_hind_mn.Rdata"))
      load(paste0("Data/out/",CMIPS[c],"/allEBS_means/ACLIM_",typeIN,"_fut_mn.Rdata"))
      eval(parse(text = paste0("dhind <- ACLIM_",typeIN,"_hind")))
      eval(parse(text = paste0("dfut  <- ACLIM_",typeIN,"_fut")))
      
       # rescale the data using mean of the hind
       tmphind    <- dhind%>%
         dplyr::filter(var%in%varlist,basin==plotbasin,year%in%hind_yrs)%>%
         dplyr::select(var,basin,year, jday,mnDate,mn_val, 
                       mnVal_hind,sdVal_hind, sim,gcmcmip,CMIP,GCM,scen,sim_type ,units,long_name)%>%
         dplyr::mutate(bc = "bias corrected",
                       GCM_scen = paste0(GCM,"_",scen),
                       mn_val_scaled = (mn_val-mnVal_hind )/sqrt(sdVal_hind))
       
       tmpfut    <- dfut%>%
         dplyr::filter(var%in%varlist,basin==plotbasin,year%in%fut_yrs)%>%
         dplyr::select(var,basin,year, jday,mnDate,val_biascorrected, 
                       mnVal_hind,sdVal_hind, sim,gcmcmip,CMIP,GCM,scen,sim_type ,units,long_name)%>%
         dplyr::rename(mn_val = val_biascorrected)%>%
         dplyr::mutate(bc = "bias corrected",
                       GCM_scen = paste0(GCM,"_",scen),
                       mn_val_scaled = (mn_val-mnVal_hind )/sqrt(sdVal_hind))
      
       
       
      # now for seasonal mean values:
      typeIN  <- "seasonal"
      varlist <- c("largeZoop_integrated")

      seasonsIN <- unique(seasons$season)
      load(paste0("Data/out/",CMIPS[c],"/allEBS_means/ACLIM_",typeIN,"_hind_mn.Rdata"))
      load(paste0("Data/out/",CMIPS[c],"/allEBS_means/ACLIM_",typeIN,"_fut_mn.Rdata"))
      eval(parse(text = paste0("dhind <- ACLIM_",typeIN,"_hind")))
      eval(parse(text = paste0("dfut  <- ACLIM_",typeIN,"_fut")))
      
      
       # rescale the data using mean of the hind
       tmphind2    <- dhind%>%
         dplyr::filter(var%in%varlist,basin==plotbasin,year%in%hind_yrs,season%in%seasonsIN)%>%
          dplyr::mutate(var = paste0(var,"_",season))%>%
         dplyr::select(var,basin,year,jday,mnDate,mn_val, 
                       mnVal_hind,sdVal_hind, sim,gcmcmip,CMIP,GCM,scen,sim_type ,units,long_name)%>%
         dplyr::mutate(bc = "bias corrected",
                       GCM_scen = paste0(GCM,"_",scen),
                       mn_val_scaled = (mn_val-mnVal_hind )/sqrt(sdVal_hind))
       
       tmpfut2    <- dfut%>%
         dplyr::filter(var%in%varlist,basin==plotbasin,year%in%fut_yrs,season%in%seasonsIN)%>%
         dplyr::mutate(var = paste0(var,"_",season))%>%
         dplyr::select(var,basin,year, jday,mnDate,val_biascorrected, 
                       mnVal_hind,sdVal_hind, sim,gcmcmip,CMIP,GCM,scen,sim_type ,units,long_name)%>%
         dplyr::rename(mn_val = val_biascorrected)%>%
         dplyr::mutate(bc = "bias corrected",
                       GCM_scen = paste0(GCM,"_",scen),
                       mn_val_scaled = (mn_val-mnVal_hind )/sqrt(sdVal_hind))
       if(c ==1){
          hind  <- rbind(tmphind,tmphind2)
          fut   <- rbind(tmpfut,tmpfut2)
       }else{
          hind  <- rbind(hind,tmphind,tmphind2)
          fut   <- rbind(fut,tmpfut,tmpfut2)
       }
       
    }
    
      # plot the data
       p <- ggplot(hind)+
         geom_line(aes(x=mnDate,y=mn_val,color=GCM_scen))+
         geom_line(data=fut,aes(x=mnDate,y=mn_val,color=GCM_scen))+
         facet_wrap(.~var,scales="free_y")+
         theme_minimal()
      p
      
      # plot the data
       p_scaled <- ggplot(hind)+
         geom_line(aes(x=mnDate,y=mn_val_scaled,color=GCM_scen))+
         geom_line(data=fut,aes(x=mnDate,y=mn_val_scaled,color=GCM_scen))+
         facet_wrap(.~var,scales="free_y")+
         theme_minimal()
      p_scaled
      
      d_wide <- reshape2::dcast(hind%>%dplyr::filter(year!=2021),year~c(var),value.var = "mn_val")
      corr   <- cor(d_wide[,-1])
      # remove those where cov is high (temp by season and cold pool by season)
      long_dat <- reshape2::melt(corr,variable.name = "variable") %>% 
      as.data.frame() 
      
      # plot covariation between variables
      long_dat %>%arrange(value)%>%
      ggplot(aes(x=Var1, y=Var2, fill=value)) + 
      geom_raster() + 
      scale_fill_viridis_c()+
      theme_minimal()+
      theme(axis.text.x = element_text(angle = 90))

   # 3 -- write data to hind .dat file
   # ------------------------------------
      
		 
      # CEATTLE uses a spp overlap index - you can skip this
          
    			overlapdat <- data.frame(
    				atf_OL=c(0.9391937,0.8167094,0.808367,0.5926875,0.7804481,0.5559549,
    				         0.4006931,0.5881404,0.7856776,0.511565,0.6352048,0.5583476,
    				         0.5792738,0.5417657,0.8212887,0.6287613,0.4536608,0.6587292,
    				         0.4884194,0.8289379,0.4399257,0.5950167,0.6388434,0.6111834,
    				         0.8742649,0.7868746,0.8024257,0.6227457,0.4956742,0.4347917,
    				         0.4791108,0.4369006,0.5613625,0.4353015),
    				south_OL=c(0.9980249,0.9390368,0.9959974,0.6130846,0.951234,0.5851891,
    				           0.4934879,0.641471,0.9809618,0.5596813,0.7196964,0.6754698,
    				           0.5774808,0.6041351,0.9406521,0.7949525,0.5306435,0.7977694,
    				           0.5345031,0.9879945,0.5079171,0.7148121,0.8997132,0.7340859,
    				           0.9962068,0.9627235,0.998043,0.8111,0.6087638,0.513057,0.5492621,
    				           0.4971361,0.665453,0.5969653)
    				)
          
            
    	      includeOverlap <- F
    			  overlap        <- matrix(1,3,length(sort(unique(hind$year))))
    			  overlap_fut    <- array(1,c(3,length(unique(fut$GCM_scen))+1,length(sort(unique(fut$year)))))
            if(includeOverlap){
              overlap[3,] <- overlapIN
              overlap[3,][overlap[3,]>1]<-1 #covs$BT2to6/covs$BT0to6
            }
     
			# Pick up here
	    
    	# Kir's .dat file
	    covars   <- unique(hind$var)
	    makeDat_hind(datIN   = hind, 
	                 outfile = fndat_hind,
	                 nsppIN    = 3,
	                 overlapIN = overlap, 
	                 nonScaled_covlist = c("temp_bottom5m","temp_surface5m"  ),
	                 Scaled_covlist    = covars)
	    
	    # generic .dat file
	    covars   <- unique(hind$var)
	    makeDat_fut( datIN   = fut, 
	                 hinddatIN  = hind, 
	                 outfile = fndat_fut,
	                 nsppIN    = 3,
	                 last_nyrs_avg   = 10, 
	                 overlapIN = overlap_fut,  #(nspp,nsim+1,nyrs_fut) 
	                 overlap_hind=overlap,
	                 nonScaled_covlist = c("temp_bottom5m","temp_surface5m"  ),
	                 Scaled_covlist    = covars)
	    
	    ### Here's a generic version that doesn't include nspp and overla[]
			# generic .dat file
	    covars   <- unique(hind$var)
	    makeDat_hind(datIN   = hind, 
	                 outfile = fndat_hind2,
	                 nsppIN    = NULL,
	                 overlapIN = NULL, 
	                 nonScaled_covlist = c("temp_bottom5m","temp_surface5m"  ),
	                 Scaled_covlist    = covars)
	    
	    # generic .dat file
	    covars   <- unique(hind$var)
	    	    makeDat_fut( datIN   = fut, 
	                 hinddatIN  = hind, 
	                 outfile = fndat_fut2,
	                 nsppIN    = NULL,
	                 last_nyrs_avg   = 10, 
	                 overlapIN    = NULL,  #(nspp,nsim+1,nyrs_fut) 
	                 overlap_hind = NULL,
	                 nonScaled_covlist = c("temp_bottom5m","temp_surface5m"  ),
	                 Scaled_covlist    = covars)
	    
			
```


# APPENDIX A: Create & bias correct ACLIM2 indices


The following code shows how the ACLIM2 indices and bias correction was done. You do not need to re-run this (it is included so you can if you want to). To explore the indices skep to the next section.

```{r annual_aclim_indices, eval=F, include=T,echo=T}
    # --------------------------------------
    # SETUP WORKSPACE
    # rm(list=ls())
    # setwd("Documents/GitHub/ACLIM2")
    tmstp  <- format(Sys.time(), "%Y_%m_%d")
    main   <- getwd()  #"~/GitHub_new/ACLIM2"
    
    # loads packages, data, setup, etc.
    suppressMessages(source("R/make.R"))
    
    tmstamp1  <- format(Sys.time(), "%Y%m%d")
    # tmstamp1  <- "20220428"
    
    update_hind  <- TRUE   # set to true to update hind and hindS; needed annually
    update_proj  <- TRUE   # set to true to update fut; not needed
    update_hist  <- TRUE   # set to true to update fut; not needed
     
    # the reference years for bias correcting in R/setup.R
    ref_years 
    
    # the year to z-score scale / delta in R/setup.R
    deltayrs 
    # the year to z-score scale / delta in R/setup.R
    deltayrs 
    data_path
    load(file.path(Rdata_path,"../weekly_vars_C.Rdata"))
    load(file.path(Rdata_path,"../weekly_vars.Rdata"))
    load(file.path(Rdata_path,"../srvy_vars_C.Rdata"))
    load(file.path(Rdata_path,"../srvy_vars.Rdata"))
  rm_wk_list <- c(
    "Iron_bottom5m","Iron_integrated","Iron_surface5m",
    "prod_Eup_integrated","prod_NCa_integrated",
    "region_area")
  rm_wk_list_C <- c( "Iron_bottom5m",
    "prod_Cop_integrated","prod_EupO_integrated","prod_EupS_integrated",
    "prod_Jel_integrated","prod_MZL_integrated",
    "prod_NCaO_integrated","prod_NCaS_integrated","Fe_depthavg",
    "region_area")
  rm_var_list <- c(
    "station_id","latitude",
    "longitude","stratum",
     "Iron_integrated","Iron_surface5m",
     "Iron_bottom5m","prod_Eup_integrated","prod_NCa_integrated",
    "doy")
  rm_var_list_C <- c(
    "station_id","latitude",
    "longitude","stratum",
     "prod_Cop_integrated","prod_EupO_integrated","prod_EupS_integrated",
    "prod_Jel_integrated","prod_MZL_integrated","Fe_depthavg",
    "prod_NCaO_integrated","prod_NCaS_integrated",
    # "Iron_integrated","Iron_surface5m",
    # "Iron_bottom5m","prod_Eup_integrated","prod_NCa_integrated"
    "doy")
    # remove these variables:
    l3srvy_varlist <- srvy_vars[!srvy_vars%in%rm_var_list]
    l3wk_varlist   <- weekly_vars[!weekly_vars%in%rm_wk_list]
    
    l3wk_varlist_C   <- weekly_vars_C[!weekly_vars_C%in%rm_wk_list_C]
    l3srvy_varlist_C <- srvy_vars_C[!srvy_vars_C%in%rm_var_list_C]
    l2_vars        <- c("temp_bottom5m", "temp_surface5m", "average_oxygen_bottom5m")
    # remove these variables:
    vl1   <- srvy_vars[!srvy_vars%in%rm_var_list]
    vl1_c <- srvy_vars_C[!srvy_vars_C%in%rm_var_list_C]
    
    vl2   <- weekly_vars[!weekly_vars%in%rm_wk_list]
    vl2_c <- weekly_vars_C[!weekly_vars_C%in%rm_wk_list_C]

    vl<-unique(c(vl1,vl2))
    vl_c<-unique(c(vl1_c,vl2_c))
    # add in largeZoop (gets generated in make_indices_region_new.R)
    vl <- c(vl,"largeZoop_integrated")
    vl_c <- c(vl_c,"largeZoop_integrated")

    # Identify which variables would be normally 
    # distributed (i.e., can have negative values)
     normvl <- c("shflux","ssflux","temp_bottom5m",
      "temp_integrated","temp_surface5m",
      "uEast_bottom5m","uEast_surface5m",
      "vNorth_bottom5m","vNorth_surface5m")

     normlist <- data.frame(var = vl, lognorm = TRUE)
    normlist$lognorm[normlist$var%in%normvl] <- FALSE
    
    normlist_c <- data.frame(var = vl_c, lognorm = TRUE)
    normlist$lognorm[normlist$var%in%normvl] <- FALSE
    
    save(weekly_vars_C,file = "Data/out/weekly_vars_C.Rdata")
    save(weekly_vars,file = "Data/out/weekly_vars.Rdata")
    save(srvy_vars_C,file = "Data/out/srvy_vars_C.Rdata")
    save(srvy_vars,file = "Data/out/srvy_vars.Rdata")
    
    # generate indices and bias corrected projections 
    # This takes approx 30 mins each
    
    gcmcmipL <- c("B10K-K20P19_CMIP6_miroc",
                  "B10K-K20P19_CMIP6_gfdl",
                  "B10K-K20P19_CMIP6_cesm") 
   
    
     CMIP6_K20P19_Indices_C <- suppressMessages(
                        makeACLIM2_Indices(
                        BC_target = "mn_val",
                        hind_sim  =  "B10K-K20P19_CORECFS",
                        histLIST  = paste0(gcmcmipL,"_historical"),
                        gcmcmipLIST = gcmcmipL,  
                        Rdata_pathIN = Rdata_path_C,
                        regnm    = "ACLIMregion_C",
                        srvynm    = "ACLIMsurveyrep_C",
  
                        normlist_IN = normlist_c,
                        sim_listIN = sim_list[-grep("historical",sim_list)]))
    
     if("CMIP6_K20P19_Indices_C"%in%ls()){                 
      saved <- FALSE
      saved <- save_indices(flIN = CMIP6_K20P19_Indices_C, 
                   subfl = "allEBS_means",
                   post_txt = "_mn",
                   CMIP_fdlr ="K20P19_CMIP6_C")
      fl <- "Data/out/CMIP6_K20P19_Indices_list_C.Rdata"
      
      if(file.exists(fl)) file.remove(fl)
      save(CMIP6_K20P19_Indices_C, file = fl)
       if(saved){
        rm(CMIP6_K20P19_Indices_C)}else{
          stop("Indices not saved!")
        }
      gc()
     }
    
     CMIP6_K20_Indices <- suppressMessages(
                        makeACLIM2_Indices(
                        BC_target = "mn_val",
                        hind_sim  =  "B10K-K20_CORECFS",
                        histLIST  = paste0(gcmcmipL,"_historical"),
                        gcmcmipLIST = gcmcmipL,
                        normlist_IN = normlist,
                        sim_listIN = sim_list[-grep("historical",sim_list)]))
    
     if("CMIP6_K20_Indices"%in%ls()){  
      saved <- FALSE
      saved <- save_indices(flIN = CMIP6_K20_Indices, 
                   subfl = "allEBS_means",
                   post_txt = "_mn",
                   CMIP_fdlr ="K20P19_CMIP6")
      fl <- "Data/out/CMIP6_K20_Indices_list.Rdata"
      
      if(file.exists(fl)) file.remove(fl)
      save(CMIP6_K20_Indices, file = fl)
      if(saved){
        rm(CMIP6_K20_Indices)}else{
          stop("Indices not saved!")
        }
      gc()
     }
    
    # CMIP5 K20P19
    gcmcmipL2 <- c("B10K-K20P19_CMIP5_MIROC","B10K-K20P19_CMIP5_GFDL","B10K-K20P19_CMIP5_CESM") 
    CMIP5_K20P19_Indices <- suppressMessages(
                        makeACLIM2_Indices(
                        BC_target = "mn_val",
                        hind_sim  =  "B10K-K20_CORECFS",
                        histLIST  = rep("B10K-K20_CORECFS",3),
                        gcmcmipLIST = gcmcmipL2,
                        normlist_IN = normlist,
                        regnm    = "ACLIMregion",
                        srvynm    = "ACLIMsurveyrep",
                        sim_listIN = sim_list[-grep("historical",sim_list)]))
    
    if("CMIP5_K20P19_Indices"%in%ls()){
      saved <- FALSE
      saved <- save_indices(flIN = CMIP5_K20P19_Indices, 
                     subfl = "allEBS_means",
                     post_txt = "_mn",
                     CMIP_fdlr ="K20P19_CMIP5")
        
        fl <- "Data/out/CMIP5_K20P19_Indices_list.Rdata"
        if(file.exists(fl)) file.remove(fl)
        save(CMIP5_K20P19_Indices, file = fl)
        
        if(saved){
        rm(CMIP5_K20P19_Indices)}else{
          stop("Indices not saved!")
        }
        gc()
    }
    
    CMIP5_K20P19_Indices_C <- suppressMessages(
                        makeACLIM2_Indices(
                        BC_target = "mn_val",
                        hind_sim  =  "B10K-K20P19_CORECFS",
                        histLIST  = rep("B10K-K20P19_CORECFS",3),
                        gcmcmipLIST = gcmcmipL2,
                         Rdata_pathIN = Rdata_path_C,
                        regnm     = "ACLIMregion_C",
                        srvynm    = "ACLIMsurveyrep_C",
  
                        normlist_IN = normlist_c,
                        sim_listIN = sim_list[-grep("historical",sim_list)]))
    
    if("CMIP5_K20P19_Indices_C"%in%ls()){
      saved <- FALSE
      saved <- save_indices(flIN = CMIP5_K20P19_Indices_C, 
                     subfl = "allEBS_means",
                     post_txt = "_mn",
                     CMIP_fdlr ="K20P19_CMIP5_C")
        
        fl <- "Data/out/CMIP5_K20P19_Indices_list_C.Rdata"
        if(file.exists(fl)) file.remove(fl)
        save(CMIP5_K20P19_Indices_C, file = fl)
         if(saved){
        rm(CMIP5_K20P19_Indices_C)}else{
          stop("Indices not saved!")
        }
        gc()
    }
    # CMIP5 H16
    gcmcmipL2 <- c("B10K-H16_CMIP5_MIROC","B10K-H16_CMIP5_GFDL","B10K-H16_CMIP5_CESM") 
    CMIP5_H16_Indices <- suppressMessages(
                        makeACLIM2_Indices(
                        BC_target = "mn_val",
                        hind_sim  =  "B10K-H16_CORECFS",
                        histLIST  = rep("B10K-H16_CORECFS",3),
                        gcmcmipLIST = gcmcmipL2,
                        sim_listIN = sim_list[-grep("historical",sim_list)]))
    if("CMIP5_H16_Indices"%in%ls()){
      saved <- FALSE
      saved <- save_indices(flIN = CMIP5_H16_Indices, 
                   subfl = "allEBS_means",
                   post_txt = "_mn",
                   CMIP_fdlr ="H16_CMIP5")
     
      fl <- "Data/out/CMIP5_H16_Indices_list.Rdata"
      if(file.exists(fl)) file.remove(fl)
      save(CMIP5_H16_Indices, file = fl)
      if(saved){
        rm(CMIP5_H16_Indices)}else{
          stop("Indices not saved!")
        }
      gc()
    }
    if(1==10){
      save(CMIP6_Indices, file = "Data/out/CMIP6_Indices_List.Rdata")
      save(CMIP5_K20_Indices, file = "Data/out/CMIP5_K20_Indices_List.Rdata")
      save(CMIP5_H16_Indices, file = "Data/out/CMIP5_H16_Indices_List.Rdata")
    }
         
```


![September large zooplankton integrated concentration](Figs/Hind_Sept_large_Zoop.jpg){ width=75% }


# misc


$$B0^k_{input}= \bar{B0}^k_{(2004:2014)}\left(\frac{B0^{a}_{2015}}{\bar{B0}^a_{(2004:2014)}}\right) $$
Where B0kinput is the unfished biomass used for setting inputs of  (e.g., B0ktarget = 0.4B0kinput) and is determined by re-scaling the spawning stock biomass from the status quo assessment in 2015 (B0a2015) to the average model spawning stock biomass for your model between 2004-2014  (i.e., B0k) using the average unfished biomass from the stock assessment model during the same period (B0a).


```{r makeReadME, echo=FALSE,eval=F, include =F}
setwd("/Users/kholsman/Documents/GitHub/ACLIM2")
file.remove(paste0("index",".html"))
# update github
file.copy(from=paste0("ACLIM2_quickStart",".html"),to=paste0("index",".html"),overwrite=T)

# file.copy(from=paste0("ACLIM2_quickStart",".md"),to=paste0("README",".md"),overwrite=T)
# file.remove(paste0("README",".md"))

# source("R/make.R")
 # copy and paste this into R window (won't work within markdown)
 rmd2md(rmd_fl = "ACLIM2_quickStart",md_fl = "README")


```






