tz = "GMT")
# get time variable from .nc file
t   <- as.POSIXct(
ncIN$var[[eval(varIN)]]$dim[[ndims]]$vals,
origin = originIN,
tz = "GMT")
# get the number of dimensions (time is often the last one)
ndims <- ncIN$var[[eval(varIN)]]$ndims
# convert time_range to POSIXct
time_range <- as.POSIXct(time_range,
origin = originIN,
tz = "GMT")
# get time variable from .nc file
t   <- as.POSIXct(
ncIN$var[[eval(varIN)]]$dim[[ndims]]$vals,
origin = originIN,
tz = "GMT")
t
time_range
time_range
time_range  = c("2006-01-22 12:00:00 GMT","2006-02-05 12:00:00 GMT")
tmp_tr
tmp_tr[,1]
tmp_tr
#'
#'get_level2
#'
get_level2<- function(ncIN,
varIN,
originIN = "1900-01-01 00:00:00",
xi_range  = 1:182,  # 182
eta_range = 1:258,  # 258
time_range  = c("2006-01-22 12:00:00 GMT","2006-02-05 12:00:00 GMT")){
# get the number of dimensions (time is often the last one)
ndims <- ncIN$var[[eval(varIN)]]$ndims
# convert time_range to POSIXct
time_range <- as.POSIXct(time_range,
origin = originIN,
tz = "GMT")
# get time variable from .nc file
t   <- as.POSIXct(
ncIN$var[[eval(varIN)]]$dim[[ndims]]$vals,
origin = originIN,
tz = "GMT")
# subset the lat and lon values
lat    <- ncvar_get(ncIN, varid = "lat_rho")[xi_range,eta_range]
lon    <- ncvar_get(ncIN, varid = "lon_rho")[xi_range,eta_range]
# get the length of the timesteps, and lat, lon
subt <- intersect(which(t>=time_range[1]), which(t<=time_range[2]))
nt   <- length(subt)
if(!nt>1) message("Invalid time range or format (e.g., '2006-01-22 12:00:00 GMT') ")
nlat    <- length(xi_range)
nlon    <- length(eta_range)
varsize <- ncIN$var[[eval(varIN)]]$varsize
val <- array(NA,c(nlat,nlon,nt))
names(val)
for( i in 1:nt ) {
# Initialize start and count to read one timestep of the variable.
start        <- rep(1,ndims)	# begin with start=(1,1,1,...,1)
start[ndims] <- subt[i]	      # change to start=(1,1,1,...,i) to read timestep i
count        <- varsize	      # begin w/count=(nx,ny,nz,...,nt), reads entire var
count[ndims] <- 1	            # change to count=(nx,ny,nz,...,1) to read 1 tstep
tmpdat       <- ncvar_get( ncIN, varIN, start=start, count=count )
val[,,i]     <- tmpdat[xi_range,eta_range]
}
# tmpdat <- ncvar_get( nc=ncIN, varid = varIN	)
#val    <- tmpdat[xi_range,eta_range,subt]
return(list(var = varIN, lat =lat, lon = lon ,time = time_range[subt],val=val ))
}
tmp      <- get_level2(
ncIN      = nc,
originIN = originIN,
varIN     = var_get,
xi_range  = xi_rangeIN,
eta_range = eta_rangeIN,
time_range  = tmp_tr[tt])
tt<-1
tmp      <- get_level2(
ncIN      = nc,
originIN = originIN,
varIN     = var_get,
xi_range  = xi_rangeIN,
eta_range = eta_rangeIN,
time_range  = tmp_tr[tt])
time_range
tmp_tr
tmp      <- get_level2(
ncIN      = nc,
originIN = originIN,
varIN     = var_get,
xi_range  = xi_rangeIN,
eta_range = eta_rangeIN,
time_range  = c(tmp_tr[tt-1],tmp_tr[tt]))
#'
#'get_level2
#'
get_level2<- function(ncIN,
varIN,
originIN = "1900-01-01 00:00:00",
xi_range  = 1:182,  # 182
eta_range = 1:258,  # 258
time_range  = c("2006-01-22 12:00:00 GMT","2006-02-05 12:00:00 GMT")){
# get the number of dimensions (time is often the last one)
ndims <- ncIN$var[[eval(varIN)]]$ndims
# convert time_range to POSIXct
time_range <- as.POSIXct(time_range,
origin = originIN,
tz = "GMT")
# get time variable from .nc file
t   <- as.POSIXct(
ncIN$var[[eval(varIN)]]$dim[[ndims]]$vals,
origin = originIN,
tz = "GMT")
# subset the lat and lon values
lat    <- ncvar_get(ncIN, varid = "lat_rho")[xi_range,eta_range]
lon    <- ncvar_get(ncIN, varid = "lon_rho")[xi_range,eta_range]
# get the length of the timesteps, and lat, lon
subt <- intersect(which(t>=time_range[1]), which(t<=time_range[2]))
nt   <- length(subt)
if(!nt>1) message("Invalid time range or format (e.g., '2006-01-22 12:00:00 GMT') ")
nlat    <- length(xi_range)
nlon    <- length(eta_range)
varsize <- ncIN$var[[eval(varIN)]]$varsize
val <- array(NA,c(nlat,nlon,nt))
names(val)
for( i in 1:nt ) {
# Initialize start and count to read one timestep of the variable.
start        <- rep(1,ndims)	# begin with start=(1,1,1,...,1)
start[ndims] <- subt[i]	      # change to start=(1,1,1,...,i) to read timestep i
count        <- varsize	      # begin w/count=(nx,ny,nz,...,nt), reads entire var
count[ndims] <- 1	            # change to count=(nx,ny,nz,...,1) to read 1 tstep
tmpdat       <- ncvar_get( ncIN, varIN, start=start, count=count )
val[,,i]     <- tmpdat[xi_range,eta_range]
}
# tmpdat <- ncvar_get( nc=ncIN, varid = varIN	)
#val    <- tmpdat[xi_range,eta_range,subt]
return(list(var = varIN, lat =lat, lon = lon ,time = time_range[subt],val=val ))
}
c(tmp_tr[tt-1],tmp_tr[tt])
tt
tt<-2
tmp      <- get_level2(
ncIN      = nc,
originIN = originIN,
varIN     = var_get,
xi_range  = xi_rangeIN,
eta_range = eta_rangeIN,
time_range  = c(tmp_tr[tt-1],tmp_tr[tt]))
time_range  = tmp_tr
time_range
# convert time_range to POSIXct
time_range <- as.POSIXct(time_range,
origin = originIN,
tz = "GMT")
nt   <- length(time_period)
time_range
time_range[i]
which(t>=time_range[i])[1]
t>=time_range[i]
which(t>=time_range[i])
which(t<=time_range[i])
rev(which(t<=time_range[i]))
rev(which(t<=time_range[i]))[1]
which(t>time_range[i])[1]
a<-which(t>time_range[i])[1]
a
b
b <-  which(t<=time_range[i])
na.omit(c(a,b))
a <- which(t>time_range[i])[1]
b <-  which(t<=time_range[i])[1]
na.omit(c(a,b))
a
b
a <- which(t>time_range[i])[1]
b <-  rev(which(t<=time_range[i]))[1]
b
na.omit(c(a,b))
a <- which(t>time_range[i])[1]
b <-  rev(which(t<=time_range[i]))[1]
na.omit(c(b,a))[1]
for( i in 1:nt ) {
a <- which(t>time_range[i])[1]
b <-  rev(which(t<=time_range[i]))[1]
#subt <- intersect(which(t>time_range[i])[1], which(t<=time_range[i]))
# Initialize start and count to read one timestep of the variable.
start        <- rep(1,ndims)	# begin with start=(1,1,1,...,1)
start[ndims] <- na.omit(c(b,a))[1]      # change to start=(1,1,1,...,i) to read timestep i
count        <- varsize	      # begin w/count=(nx,ny,nz,...,nt), reads entire var
count[ndims] <- 1	            # change to count=(nx,ny,nz,...,1) to read 1 tstep
tmpdat       <- ncvar_get( ncIN, varIN, start=start, count=count )
val[,,i]     <- tmpdat[xi_range,eta_range]
}
time <- time_range
for( i in 1:nt ) {
a <- which(t>time_range[i])[1]
b <-  rev(which(t<=time_range[i]))[1]
#subt <- intersect(which(t>time_range[i])[1], which(t<=time_range[i]))
# Initialize start and count to read one timestep of the variable.
start        <- rep(1,ndims)	# begin with start=(1,1,1,...,1)
start[ndims] <- na.omit(c(b,a))[1]      # change to start=(1,1,1,...,i) to read timestep i
count        <- varsize	      # begin w/count=(nx,ny,nz,...,nt), reads entire var
count[ndims] <- 1	            # change to count=(nx,ny,nz,...,1) to read 1 tstep
tmpdat       <- ncvar_get( ncIN, varIN, start=start, count=count )
val[,,i]     <- tmpdat[xi_range,eta_range]
time[i]      <- t[ na.omit(c(b,a))[1]  ]
}
time
time_range
time
time
length (t)
time[1;10]
time[1:10]
time_range[1:10]
#'
#'get_level2
#'
get_level2<- function(ncIN,
varIN,
originIN = "1900-01-01 00:00:00",
xi_range  = 1:182,  # 182
eta_range = 1:258,  # 258
time_range  = c("2006-01-22 12:00:00 GMT","2006-02-05 12:00:00 GMT")){
# get the number of dimensions (time is often the last one)
ndims <- ncIN$var[[eval(varIN)]]$ndims
# convert time_range to POSIXct
time_range <- as.POSIXct(time_range,
origin = originIN,
tz = "GMT")
# get time variable from .nc file
t   <- as.POSIXct(
ncIN$var[[eval(varIN)]]$dim[[ndims]]$vals,
origin = originIN,
tz = "GMT")
# subset the lat and lon values
lat    <- ncvar_get(ncIN, varid = "lat_rho")[xi_range,eta_range]
lon    <- ncvar_get(ncIN, varid = "lon_rho")[xi_range,eta_range]
# get the length of the timesteps, and lat, lon
nt   <- length(time_range)
if(!nt>1) message("Invalid time range or format (e.g., '2006-01-22 12:00:00 GMT') ")
nlat    <- length(xi_range)
nlon    <- length(eta_range)
varsize <- ncIN$var[[eval(varIN)]]$varsize
val <- array(NA,c(nlat,nlon,nt))
names(val)
time <- time_range
for( i in 1:nt ) {
a <- which(t>time_range[i])[1]
b <-  rev(which(t<=time_range[i]))[1]
#subt <- intersect(which(t>time_range[i])[1], which(t<=time_range[i]))
# Initialize start and count to read one timestep of the variable.
start        <- rep(1,ndims)	# begin with start=(1,1,1,...,1)
start[ndims] <- na.omit(c(b,a))[1]      # change to start=(1,1,1,...,i) to read timestep i
count        <- varsize	      # begin w/count=(nx,ny,nz,...,nt), reads entire var
count[ndims] <- 1	            # change to count=(nx,ny,nz,...,1) to read 1 tstep
tmpdat       <- ncvar_get( ncIN, varIN, start=start, count=count )
val[,,i]     <- tmpdat[xi_range,eta_range]
time[i]      <- t[ na.omit(c(b,a))[1]  ]
}
# tmpdat <- ncvar_get( nc=ncIN, varid = varIN	)
#val    <- tmpdat[xi_range,eta_range,subt]
return(list(var = varIN, lat =lat, lon = lon ,time = time, time_range=time_range,val=val ))
}
#'
#' get_l3.R
#' Convert Level 3 .nc files to Rdata files
#' @param web_nc  TRUE = pull files from the web;  FALSE =  use 'local_path'
#' @param download_nc  TURE = download the nc files from the web, FALSE = access nc files without downloading
#' @param rd_path Path where the Rdata file (outputs) should be saved
#' @param local_path Path where .nc files are stored locally
#' @param varlist list of variables to extract from the .nc files
#' @param proj_list list of simulations to draw from
#' @example
#'
# grab nc files from the aclim server and convert to rdatafiles:
# get_l2(
#   ID          = "",
#   ds_list     = dl,
#   trIN        = tr,
#   sub_varlist = svl,
#   sim_list    = sl  )
get_l2 <-function(
web_nc      = TRUE,
download_nc = FALSE,
rd_path     = file.path(main,Rdata_path),
local_path  = NULL,
xi_rangeIN  = 1:182,
eta_rangeIN = 1:258,
ID          = "",
ds_list     = dl,
originIN      = "1900-01-01 00:00:00",
trIN        = c("-08-1 12:00:00 GMT"),
sub_varlist = list(
"temp",
"temp",
c("EupS","Cop","NCaS") ),
sim_list  ) {
# preview the datasets on the server:
url_list <- tds_list_datasets(thredds_url = ACLIM_data_url)
# now grab dattat for the hindcast and projection sets:
for(m in sim_list){
# create the simulation Level3 folder (and overwrite it if overwrite is set to T)
if(!dir.exists(file.path(rd_path,m)))
dir.create(file.path(rd_path,m))
if(!dir.exists(file.path(rd_path,m,"/Level2")) )
dir.create(file.path(rd_path,m,"/Level2"))
for(d in 1:length(ds_list)){
# create filename:
tmp_fl  <- paste0(d,"_",m)
tmppath <- file.path(local_path,paste0(m,"/Level2/",ds_list[d],"_",m,".nc"))
tmppath <- stringr::str_replace(tmppath," 5m","_5m")
if(web_nc){
# create the temporary URL
# get the url for the simulation
m_url       <- url_list[url_list$dataset == paste0(m,"/"),]$path
# preview the projection and hindcast data and data catalogs (Level 1, 2, and 3):
m_datasets  <- tds_list_datasets(thredds_url = m_url)
# get Level 2 .nc file URL
m_l2_cat       <- m_datasets[m_datasets$dataset == "Level 2/",]$path
m_l2_datasets  <- tds_list_datasets(m_l2_cat)
m_l2_vT_url    <- m_l2_datasets[m_l2_datasets$dataset == ds_list[d],]$path
m_flnm         <- strsplit(m_l2_vT_url,split="dataset=")[[1]][2]
m_flnm         <- stringr::str_replace(m_flnm,"Level2_","")
tmppath        <- file.path(local_path,paste0(m,"/Level2/",ds_list[d],"_",m,".nc"))
if(ds_list[d] =="Surface 5m")
m_flnm       <- stringr::str_replace(m_flnm,"surface_5m","surface5m")
if(download_nc){
error("downloading level 2 files not yet avail.")
if(1==10){
# create local folders for nc files
if(!dir.exists(local_path))
dir.create(local_path)
if(!dir.exists( file.path( local_path,m ) ))
dir.create( file.path(local_path,m) )
if(!dir.exists( file.path( local_path,paste0(m,"/Level2/") ) ))
dir.create( file.path(local_path,paste0(m,"/Level2/")) )
# download the nc file and save locally
#https://data.pmel.noaa.gov/aclim/thredds/fileServer/B10K-K20_CORECFS/Level2/2015-2019/B10K-K20_CORECFS_2015-2019_average_temp_bottom5m.nc
tmpURL         <- paste0(paste0(ACLIM_data_url,"fileServer/Level2/"),m_flnm,".nc")
download.file(tmpURL,destfile = tmppath, overwrite = T)
# open the local netcdf file
nc     <- nc_open(tmppath)
}
}else{
tmpURL         <- paste0(paste0(ACLIM_data_url,"dodsC/Level2/"),m_flnm,".nc")
# open the netcdf file remotely
nc             <- nc_open(tmpURL)
}
}else{
nc      <- nc_open(tmp_path)
}
# available variables:
names(nc$var)
time_steps  <- as.POSIXct(
nc$var[[ sub_varlist[[d]][1] ]]$dim[[3]]$vals,
origin = originIN,
tz = "GMT")
# get years in simulation
yrs    <- sort(unique(substr(time_steps,1,4)))
tmp_tr <-  paste0(yrs,trIN)
# subset the lat and lon values
lat    <- ncvar_get(nc, varid = "lat_rho")
lon    <- ncvar_get(nc, varid = "lon_rho")
#M2 <- (56.87°N, -164.06°W)
for(var_get in sub_varlist[[d]]){
# convert the nc files into a long data.frame for each variable
# Tinker: try extracting other vars like "NO3", or "uEast"
tmp_var      <- get_level2(
ncIN      = nc,
originIN = originIN,
varIN     = var_get,
xi_range  = xi_rangeIN,
eta_range = eta_rangeIN,
time_range  = tmp_tr)
# rename the object
eval(parse(text =paste0(var_get,"<-tmp_var") ))
# save the nc file in the Data/in/Newest/Rdata/ [ simulation]/Level3 folder
tmp_path <- file.path( main,Rdata_path,m,"Level2",
paste0(m_flnm,"_",var_get,ID,".Rdata"))
eval(parse(text =paste0("save(",var_get,", file=tmp_path)")))
eval(parse(text =paste0("rm(",var_get,")") ))
cat(paste("success:",tmp_path, "saved in local folder\n"))
}
# close the nc file
nc_close(nc)
}
}
}
get_l2(
ID          = IDin,
xi_rangeIN  = seq(1,182,10),
eta_rangeIN = seq(1,258,10),
ds_list     = dl,
trIN        = tr,
sub_varlist = svl,
sim_list    = sim  )
# load R data file
load(fl)   # temp
# there are smarter ways to do this;looping because
# we don't want to mess it up but this is slow...
i <-1
data_long <- data.frame(latitude = as.vector(temp$lat),
longitude = as.vector(temp$lon),
val = as.vector(temp$val[,,i]),
time = temp$time[i],
year = substr( temp$time[i],1,4)
)
for(i in 2:dim(temp$val)[3])
data_long <- rbind(data_long,
data.frame(latitude = as.vector(temp$lat),
longitude = as.vector(temp$lon),
val = as.vector(temp$val[,,i]),
time = temp$time[i],
year = substr( temp$time[i],1,4))
)
# get the mean values for the time blocks from the rdata versions
# will throw "implicit NA" errors that can be ignored
tmp_var <-data_long # get mean var val for each time segment
j<-0
for(i in 1:length(time_seg)){
if(length(which(tmp_var$year%in%time_seg[[i]]))>0){
j <- j +1
mn_tmp_var <- tmp_var%>%
filter(year%in%time_seg[[i]],!is.na(val))%>%
group_by(latitude, longitude)%>%
summarise(mnval = mean(val,rm.na=T))
mn_tmp_var$time_period = factor(names(time_seg)[i],levels=names(time_seg))
if(j == 1) mn_var <- mn_tmp_var
if(j >  1) mn_var <- rbind(mn_var,mn_tmp_var)
rm(mn_tmp_var)
}
}
# convert results to a shapefile
L2_sf  <- convert2shp(mn_var%>%filter(!is.na(mnval)))
p9     <- plot_stations_basemap(sfIN = L2_sf,
fillIN = "mnval",
colorIN = "mnval",
sizeIN=.8) +
facet_grid(.~time_period)+
scale_color_viridis_c()+
scale_fill_viridis_c()+
guides(
color =  guide_legend(title="Bottom T (degC)"),
fill  =  guide_legend(title="Bottom T (degC)")) +
ggtitle(paste(sim,var_use,IDin))
# This is slow but it works (repeat dev.new() twice if in Rstudio)...
dev.new()
p9
p9
graphics.off()
graphics.off()
dev.new()
dev.new()
dev.new()
p9
p9     <- plot_stations_basemap(sfIN = L2_sf,
fillIN = "mnval",
colorIN = "mnval",
sizeIN=.3) +
facet_grid(.~time_period)+
scale_color_viridis_c()+
scale_fill_viridis_c()+
guides(
color =  guide_legend(title="Bottom T (degC)"),
fill  =  guide_legend(title="Bottom T (degC)")) +
ggtitle(paste(sim,var_use,IDin))
p9
p9     <- plot_stations_basemap(sfIN = L2_sf,
fillIN = "mnval",
colorIN = "mnval",
sizeIN=.6) +
facet_grid(.~time_period)+
scale_color_viridis_c()+
scale_fill_viridis_c()+
guides(
color =  guide_legend(title="Bottom T (degC)"),
fill  =  guide_legend(title="Bottom T (degC)")) +
ggtitle(paste(sim,var_use,IDin))
p9
ggsave(file="Figs/sub_grid_mn_BT_Aug1.jpg",width=8,height=6)
p4
ggsave(file="Figs/weekly_bystrata.jpg",width=8,height=5)
getwd()
ggsave(file="Figs/weekly_bystrata.jpg",width=8,height=5)
dir("Figs")
dev.new()
p4
ggsave(file="Figs/weekly_bystrata.jpg",width=8,height=5)
graphics.off()
graphics.off()
p4
ggsave(file="Figs/weekly_bystrata.jpg",width=8,height=5)
main
ggsave(file=file.path(main,"Figs/weekly_bystrata.jpg"),width=8,height=5)
dev.off()
update.figs<-T
p8
ggsave(file=file.path(main,"Figs/PhenShift_large_Zoop.jpg"),width=8,height=5)
p9
ggsave(file=file.path(main,"Figs/sub_grid_mn_BT_Aug1.jpg"),width=8,height=6)
# copy and paste this into R window (won't work within markdown)
rmd2md(rmd_fl = "GettingStarted_ACLIM_ROMSNPZ_2021v2",md_fl = "README")
# copy and paste this into R window (won't work within markdown)
rmd2md(rmd_fl = "GettingStarted_ACLIM_ROMSNPZ_2021v2",md_fl = "README")
# copy and paste this into R window (won't work within markdown)
rmd2md(rmd_fl = "GettingStarted_ACLIM_ROMSNPZ_2021v2",md_fl = "README")
setwd(main)
# copy and paste this into R window (won't work within markdown)
rmd2md(rmd_fl = "GettingStarted_ACLIM_ROMSNPZ_2021v2",md_fl = "README")
maain
main
